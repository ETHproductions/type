<!doctype html>
<html>
	<head>
		<title>Typing</title>
		<script>
			// Too lazy for jQuery :P
			function $(x){return document.getElementById(x);}
			
			// Formats a number of ms as M:SS.sss (or S.sss, if less than one minute).
			function tf(n){return (n >= 6e4? (n / 6e4 | 0) + ":" + (n % 6e4 < 1e4 ? "0" : "") : "") + (n % 6e4 / 1e3).toFixed(3);}
			
			var update,
				interval,
				curtext = '<span id="cursor" style="border-right: 2px solid black"></span>',
				cursor = 0, // Keeps track of which state the cursor should be in (on/off).
				started = false,  // Whether the time has started. If false, the timer will not run.
				finished = false, // Whether the user successfully finished. If true, the timer will not run and the input will not update.
				disabled = false; // Whether the user messed up badly (i.e. pasted something). If true, the input will not update.
			
			// Flashes the cursor. Runs every 10 ms, but changes state every 500.
			function updatecursor(){
				if(cursor % 50 === 0)
				$("cursor").style.borderRight = "2px solid " + (cursor % 100 === 0 ? "black" : "transparent");
				cursor++;
			}
			
			// Ends the flashing of the cursor. PERMANENTLY.
			function endCursor(){
				clearInterval(interval);
				$("cursor").style.borderRight = "";
			}
			
			// start kicks off a new game.
			function start(string) {
				var date = 0,
					oldtext = "";
				
				// Resetting all important values of elements.
				$("target").innerHTML = string;
				$("output").innerHTML = curtext;
				$("output").style.color = "red";
				$("timer").innerHTML = "0.000";
				$("timer").style.color = "";
				$("input").value = "";
				
				interval = setInterval(updatecursor, 10);
				
				// update is run the instant a key is pressed.
				update = function update(){
					var input = $("input").value;
					if(input.length === 0) started = true, date = new Date, tick();
					// If the game hasn't ended, we call update2 after 10 ms so the textarea can update its content.
					!finished && !disabled && setTimeout(update2, 10);
				}
				
				// update2 is run an instant after a key is pressed.
				function update2(){
					if(finished) return;
					var input = $("input").value, time;
					cursor = 0;
					
					// We detect if the text has been completely erased, in which case the time is reset.
					if(input.length === 0 && oldtext.length > 0) {
						started = false;
						$("timer").innerHTML = "Reset";
					}
					
					// Now we detect whether the user has pasted something.
					// We check if the length has increased by at least 4, because 3 or less can be caused by mashing the keyboard.
					if(input.length >= oldtext.length + 4) {
						disabled = true;
						$("output").innerHTML = input = "Pasting is not allowed.";
						endCursor();
					} else {
						$("output").innerHTML = input + curtext;
					}
					
					// If the user has typed out the full string, finish the program.
					if(input === string) {
						finished = true;
						endCursor();
						$("output").style.color = "green";
						$("timer").style.color = "green";
						$("timer").innerHTML = tf(new Date - date);
					}
					oldtext = input;
				}
				
				// tick is run every 43 ms after the game starts. It simply updates the timer.
				function tick(){
					if(!started || finished) return;
					$("timer").innerHTML = tf(new Date - date);
					setTimeout(tick, 43);
				}
			}
		</script>
	</head>
	<body>
		<pre id="target" style="font-size: 28px;"></pre>
		<pre id="output" style="font-size: 28px; height: 1em;"><span id="cursor"></span></pre>
		<pre id="timer" style="font-size: 28px;"></pre>
		<textarea id="input" style="opacity: 0; position: absolute; top: 0; left: 0; bottom: 0; width:99%;" onkeydown="update()" autofocus></textarea>
		<script>
			start("Speed typing is fun!");
		</script>
	</body>
</html>
